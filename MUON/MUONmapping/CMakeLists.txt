# **************************************************************************
# * Copyright(c) 1998-2014, ALICE Experiment at CERN, All rights reserved. *
# *                                                                        *
# * Author: The ALICE Off-line Project.                                    *
# * Contributors are mentioned in the code where appropriate.              *
# *                                                                        *
# * Permission to use, copy, modify and distribute this software and its   *
# * documentation strictly for non-commercial purposes is hereby granted   *
# * without fee, provided that the above copyright notice appears in all   *
# * copies and that both the copyright notice and this permission notice   *
# * appear in the supporting documentation. The authors make no claims     *
# * about the suitability of this software for any purpose. It is          *
# * provided "as is" without express or implied warranty.                  *
# **************************************************************************

# Module
set(MODULE MUONmapping)
add_definitions(-D_MODULE_="${MODULE}")

# Module include folder
include_directories(${AliRoot_SOURCE_DIR}/MUON/${MODULE})

# Additional include folders in alphabetical order except ROOT
include_directories(SYSTEM ${ROOT_INCLUDE_DIR})
include_directories(${AliRoot_SOURCE_DIR}/MUON/MUONcore
                    ${AliRoot_SOURCE_DIR}/STEER/CDB
                    ${AliRoot_SOURCE_DIR}/STEER/STEERBase
                   )

# Sources in alphabetical order
set(SRCS
    AliMpArea.cxx
    AliMpBusPatch.cxx
    AliMpCathodType.cxx
    AliMpCDB.cxx
    AliMpConnection.cxx
    AliMpConstants.cxx
    AliMpDataMap.cxx
    AliMpDataProcessor.cxx
    AliMpDataStreams.cxx
    AliMpDCSNamer.cxx
    AliMpDDL.cxx
    AliMpDDLStore.cxx
    AliMpDEIterator.cxx
    AliMpDEManager.cxx
    AliMpDEStore.cxx
    AliMpDetElement.cxx
    AliMpEncodePair.cxx
    AliMpFastSegmentation.cxx
    AliMpFiles.cxx
    AliMpFrtCrocusConstants.cxx
    AliMpHelper.cxx
    AliMpHVUID.cxx
    AliMpLocalBoard.cxx
    AliMpManuIterator.cxx
    AliMpManuStore.cxx
    AliMpManuUID.cxx
    AliMpMotif.cxx
    AliMpMotifMap.cxx
    AliMpMotifPosition.cxx
    AliMpMotifPositionPadIterator.cxx
    AliMpMotifReader.cxx
    AliMpMotifSpecial.cxx
    AliMpMotifType.cxx
    AliMpMotifTypePadIterator.cxx
    AliMpPad.cxx
    AliMpPadRow.cxx
    AliMpPadRowLSegment.cxx
    AliMpPadRowRSegment.cxx
    AliMpPadUID.cxx
    AliMpPCB.cxx
    AliMpPCBPadIterator.cxx
    AliMpPlaneType.cxx
    AliMpRegionalTrigger.cxx
    AliMpRow.cxx
    AliMpRowSegment.cxx
    AliMpRowSegmentLSpecial.cxx
    AliMpRowSegmentRSpecial.cxx
    AliMpSectorAreaHPadIterator.cxx
    AliMpSectorAreaVPadIterator.cxx
    AliMpSector.cxx
    AliMpSectorPadIterator.cxx
    AliMpSectorReader.cxx
    AliMpSectorSegmentation.cxx
    AliMpSegmentation.cxx
    AliMpSlat.cxx
    AliMpSlatMotifMap.cxx
    AliMpSlatPadIterator.cxx
    AliMpSlatSegmentation.cxx
    AliMpSt345Reader.cxx
    AliMpStation12Type.cxx
    AliMpStationType.cxx
    AliMpSubZone.cxx
    AliMpTriggerCrate.cxx
    AliMpTrigger.cxx
    AliMpTriggerPadIterator.cxx
    AliMpTriggerReader.cxx
    AliMpTriggerSegmentation.cxx
    AliMpUID.cxx
    AliMpVIndexed.cxx
    AliMpVMotif.cxx
    AliMpVPadIterator.cxx
    AliMpVPadRowSegment.cxx
    AliMpVRowSegment.cxx
    AliMpVRowSegmentSpecial.cxx
    AliMpVSegmentation.cxx
    AliMpZone.cxx
   )

# Headers from sources
string(REPLACE ".cxx" ".h" HDRS "${SRCS}")

# Generate the dictionary
# It will create G_ARG1.cxx and G_ARG1.h / ARG1 = function first argument
get_directory_property(incdirs INCLUDE_DIRECTORIES)
generate_dictionary("${MODULE}" "${MODULE}LinkDef.h" "${HDRS}" "${incdirs}")


# Dependencies
set(ROOT_DEPENDENCIES Core Physics RIO)
set(ALIROOT_DEPENDENCIES STEERBase CDB MUONcore)

# Generate the ROOT map
# Dependecies
set(LIBDEPS ${ALIROOT_DEPENDENCIES} ${ROOT_DEPENDENCIES})
generate_rootmap("${MODULE}" "${LIBDEPS}" "${CMAKE_CURRENT_SOURCE_DIR}/${MODULE}LinkDef.h")

# Create an object to be reused in case of static libraries 
# Otherwise the sources will be compiled twice
add_library(${MODULE}-object OBJECT ${SRCS} G__${MODULE}.cxx)
# Follow headers dependencies
add_dependencies(${MODULE}-object ${ALIROOT_DEPENDENCIES})
# Add a library to the project using the object
add_library(${MODULE} SHARED $<TARGET_OBJECTS:MUONmapping-object>)

# linking
target_link_libraries(${MODULE} ${ALIROOT_DEPENDENCIES} ${ROOT_DEPENDENCIES})

# Setting the correct headers for the object as gathered from the dependencies
target_include_directories(${MODULE}-object PUBLIC $<TARGET_PROPERTY:${MODULE},INCLUDE_DIRECTORIES>)
set_target_properties(${MODULE}-object PROPERTIES COMPILE_DEFINITIONS $<TARGET_PROPERTY:${MODULE},COMPILE_DEFINITIONS>)

# Additional compilation flags
set_target_properties(${MODULE}-object PROPERTIES COMPILE_FLAGS " ")

# System dependent: Modify the way the library is build
if(${CMAKE_SYSTEM} MATCHES Darwin)
    set_target_properties(${MODULE} PROPERTIES LINK_FLAGS "-undefined dynamic_lookup")
endif(${CMAKE_SYSTEM} MATCHES Darwin)

# Installation
install(TARGETS ${MODULE}
        ARCHIVE DESTINATION lib
        LIBRARY DESTINATION lib)

install(DIRECTORY . DESTINATION include FILES_MATCHING PATTERN "*.h")

# Static version if DA enabled
if(ALIROOT_STATIC)
    add_library(${MODULE}-static STATIC $<TARGET_OBJECTS:MUONmapping-object>)
    set_target_properties(${MODULE}-static PROPERTIES OUTPUT_NAME ${MODULE})

    # list of shared dependencies / the name of the variable containing the list of static ones
    generate_static_dependencies("${ALIROOT_DEPENDENCIES}" "STATIC_ALIROOT_DEPENDENCIES")
    target_link_libraries(${MODULE}-static ${STATIC_ALIROOT_DEPENDENCIES} Root)
    
    # Public include folders that will be propagated to the dependecies
    target_include_directories(${MODULE}-static PUBLIC ${incdirs})

    set_target_properties(${MODULE}-static PROPERTIES LINK_FLAGS "-Wl,--whole-archive")

    # Installation
    install(TARGETS ${MODULE}-static
            ARCHIVE DESTINATION lib
            LIBRARY DESTINATION lib)
endif(ALIROOT_STATIC)

